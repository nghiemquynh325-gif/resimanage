// ============================================
// PATCH: Add Land Certificate and Property Fields to HouseholdFormModal
// ============================================
// File: components/households/HouseholdFormModal.tsx

// 1. UPDATE ZOD SCHEMA (around line 15-26)
// Replace the existing schema with:

const householdSchema = z.object({
  headOfHouseholdId: z.string().min(1, "Vui lòng chọn chủ hộ"),
  unit: z.string().min(1, "Vui lòng nhập tổ dân phố"),
  isBusiness: z.boolean().optional(),
  businessName: z.string().optional(),
  businessLicenseNumber: z.string().optional(),
  businessLicenseDate: z.string().optional(),
  businessOwnerId: z.string().optional(),
  businessManagerId: z.string().optional(),
  // Land certificate fields
  landPlotNumber: z.string().optional(),
  landMapSheetNumber: z.string().optional(),
  certificateIssueNumber: z.string().optional(),
  certificateRegistryNumber: z.string().optional(),
  // Property details
  businessArea: z.number().optional(),
  businessConstructionYear: z.number().optional(),
  businessFloors: z.number().optional(),
  businessRooms: z.number().optional(),
  businessSector: z.string().optional(),
  // Household types
  isPoorHousehold: z.boolean().optional(),
  poorHouseholdNotes: z.string().optional(),
  isPolicyHousehold: z.boolean().optional(),
  policyHouseholdNotes: z.string().optional(),
}).refine((data) => {
  // If business, require business fields
  if (data.isBusiness) {
    return !!(data.businessName && data.businessLicenseNumber && data.businessLicenseDate);
  }
  return true;
}, {
  message: "Vui lòng điền đầy đủ thông tin kinh doanh",
  path: ["businessName"],
});

// 2. UPDATE DEFAULT VALUES (around line 60-75)
// Add these fields to defaultValues:

defaultValues: {
  headOfHouseholdId: '',
  unit: '',
  isBusiness: false,
  businessName: '',
  businessLicenseNumber: '',
  businessLicenseDate: '',
  businessOwnerId: '',
  businessManagerId: '',
  // Land certificate fields
  landPlotNumber: '',
  landMapSheetNumber: '',
  certificateIssueNumber: '',
  certificateRegistryNumber: '',
  // Property details
  businessArea: undefined,
  businessConstructionYear: undefined,
  businessFloors: undefined,
  businessRooms: undefined,
  businessSector: '',
  isPoorHousehold: false,
  poorHouseholdNotes: '',
  isPolicyHousehold: false,
  policyHouseholdNotes: '',
}

// 3. UPDATE RESET LOGIC IN useEffect (around line 85-105)
// Add these fields to the reset call when initialData exists:

reset({
  headOfHouseholdId: initialData.headOfHouseholdId,
  unit: initialData.unit,
  isBusiness: initialData.isBusiness || false,
  businessName: initialData.businessName || '',
  businessLicenseNumber: initialData.businessLicenseNumber || '',
  businessLicenseDate: initialData.businessLicenseDate || '',
  businessOwnerId: initialData.businessOwnerId || '',
  businessManagerId: initialData.businessManagerId || '',
  // Land certificate fields
  landPlotNumber: initialData.landPlotNumber || '',
  landMapSheetNumber: initialData.landMapSheetNumber || '',
  certificateIssueNumber: initialData.certificateIssueNumber || '',
  certificateRegistryNumber: initialData.certificateRegistryNumber || '',
  // Property details
  businessArea: initialData.businessArea,
  businessConstructionYear: initialData.businessConstructionYear,
  businessFloors: initialData.businessFloors,
  businessRooms: initialData.businessRooms,
  businessSector: initialData.businessSector || '',
  isPoorHousehold: initialData.isPoorHousehold || false,
  poorHouseholdNotes: initialData.poorHouseholdNotes || '',
  isPolicyHousehold: initialData.isPolicyHousehold || false,
  policyHouseholdNotes: initialData.policyHouseholdNotes || '',
});

// 4. UPDATE SUBMIT PAYLOAD (around line 150-180)
// Add these fields to the payload:

const payload: any = {
  headOfHouseholdId: data.headOfHouseholdId,
  unit: data.unit,
  memberIds: selectedMembers,
  relationships: cleanRelationships,
  isBusiness: data.isBusiness || false,
  isPoorHousehold: data.isPoorHousehold || false,
  isPolicyHousehold: data.isPolicyHousehold || false,
};

// Add business fields if business household
if (data.isBusiness) {
  payload.businessName = data.businessName;
  payload.businessLicenseNumber = data.businessLicenseNumber;
  payload.businessLicenseDate = data.businessLicenseDate;
  payload.businessOwnerId = data.businessOwnerId || data.headOfHouseholdId;
  payload.businessManagerId = data.businessManagerId;
}

// Always send land certificate and property fields
payload.landPlotNumber = data.landPlotNumber || null;
payload.landMapSheetNumber = data.landMapSheetNumber || null;
payload.certificateIssueNumber = data.certificateIssueNumber || null;
payload.certificateRegistryNumber = data.certificateRegistryNumber || null;
payload.businessArea = data.businessArea || null;
payload.businessConstructionYear = data.businessConstructionYear || null;
payload.businessFloors = data.businessFloors || null;
payload.businessRooms = data.businessRooms || null;
payload.businessSector = data.businessSector || null;

// Add poor household notes if applicable
if (data.isPoorHousehold) {
  payload.poorHouseholdNotes = data.poorHouseholdNotes;
}

// Add policy household notes if applicable
if (data.isPolicyHousehold) {
  payload.policyHouseholdNotes = data.policyHouseholdNotes;
}

// 5. ADD FORM FIELDS (after business manager fields, around line 400)
// Add this section after the business manager select:

{/* Business Property Information Section */}
{isBusiness && (
  <div className="space-y-4 border-t border-slate-200 pt-4 mt-4">
    <h4 className="font-semibold text-slate-800 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
      </svg>
      Thông tin Bất động sản
    </h4>

    {/* Land Certificate Information */}
    <div className="bg-slate-50 p-4 rounded-lg space-y-3">
      <p className="text-sm font-medium text-slate-700">Thông tin Giấy chứng nhận</p>
      
      <div className="grid grid-cols-2 gap-4">
        <Input
          label="Thửa đất số"
          {...register('landPlotNumber')}
          placeholder="Ví dụ: 123"
        />
        
        <Input
          label="Tờ bản đồ số"
          {...register('landMapSheetNumber')}
          placeholder="Ví dụ: 45"
        />
        
        <Input
          label="Số phát hành GCN"
          {...register('certificateIssueNumber')}
          placeholder="Nhập số phát hành..."
        />
        
        <Input
          label="Số vào sổ cấp giấy"
          {...register('certificateRegistryNumber')}
          placeholder="Nhập số vào sổ..."
        />
      </div>
    </div>

    {/* Property Details */}
    <div className="bg-slate-50 p-4 rounded-lg space-y-3">
      <p className="text-sm font-medium text-slate-700">Chi tiết Bất động sản</p>
      
      <div className="grid grid-cols-2 gap-4">
        <Input
          label="Diện tích (m²)"
          type="number"
          {...register('businessArea', { valueAsNumber: true })}
          placeholder="Nhập diện tích..."
        />
        
        <Input
          label="Năm xây dựng"
          type="number"
          {...register('businessConstructionYear', { valueAsNumber: true })}
          placeholder="Ví dụ: 2020"
        />
        
        <Input
          label="Số tầng"
          type="number"
          {...register('businessFloors', { valueAsNumber: true })}
          placeholder="Nhập số tầng..."
        />
        
        <Input
          label="Số phòng"
          type="number"
          {...register('businessRooms', { valueAsNumber: true })}
          placeholder="Nhập số phòng..."
        />
      </div>
      
      <Input
        label="Ngành nghề kinh doanh"
        {...register('businessSector')}
        placeholder="Ví dụ: Kinh doanh nhà trọ, Cửa hàng tạp hóa..."
      />
    </div>
  </div>
)}
